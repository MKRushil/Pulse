2025-12-09 00:27:37 - s_cbr.RateLimiter - INFO - âœ… RateLimiter åˆå§‹åŒ–å®Œæˆ
2025-12-09 00:27:37 - s_cbr.SCBREngine - INFO - âœ… RateLimiter åˆå§‹åŒ–æˆåŠŸ
2025-12-09 00:27:37 - s_cbr.SCBREngine - INFO - âœ… OWASPæ˜ å°„å™¨åˆå§‹åŒ–æˆåŠŸ
2025-12-09 00:27:37 - s_cbr.SCBREngine - INFO - âœ… å®‰å…¨æ¨¡çµ„åˆå§‹åŒ–å®Œæˆ
2025-12-09 00:27:37 - s_cbr.DialogManager - INFO - âœ… å°è©±ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ (max_sessions=100)
2025-12-09 00:27:37 - s_cbr.LLMClient - INFO - âœ… LLMå®¢æˆ¶ç«¯åˆå§‹åŒ–: model=meta/llama-3.3-70b-instruct, max_tokens=4000, timeout=30.0s
2025-12-09 00:27:37 - s_cbr.SCBREngine - INFO - âœ… LLM å®¢æˆ¶ç«¯åˆå§‹åŒ–æˆåŠŸ
2025-12-09 00:27:37 - s_cbr.SCBREngine - INFO - âœ… EmbedClient åˆå§‹åŒ–æˆåŠŸ
2025-12-09 00:27:37 - s_cbr.SearchEngine - INFO - [SearchEngine] Connected to Weaviate
2025-12-09 00:27:37 - s_cbr.SCBREngine - INFO - âœ… SearchEngine åˆå§‹åŒ–æˆåŠŸ
2025-12-09 00:27:37 - s_cbr.FourLayerPipeline - INFO - [FourLayerPipeline] TCMTools å·¥å…·åº«å·²æ›è¼‰
2025-12-09 00:27:37 - s_cbr.FourLayerPipeline - INFO - [L2] Agentic æ¨¡å¼æœªå•Ÿç”¨ï¼Œä½¿ç”¨å‚³çµ± L2 æ¨¡å¼
2025-12-09 00:27:37 - s_cbr.SCBREngine - INFO - âœ… å››å±¤ SCBR ç®¡ç·šåˆå§‹åŒ–å®Œæˆ
2025-12-09 00:27:37 - s_cbr.SCBREngine - INFO - âœ… S-CBR Engine åˆå§‹åŒ–å®Œæˆ (å«å®‰å…¨é˜²è­·)
2025-12-09 00:27:38 - s_cbr.backend.main - INFO - ğŸš€ TCM S-CBR Backend v2.2 å•Ÿå‹•
2025-12-09 00:27:38 - s_cbr.backend.main - INFO - ============================================================
2025-12-09 00:27:38 - s_cbr.backend.main - INFO - ğŸ“¦ å·²è¼‰å…¥æ¨¡çµ„:
2025-12-09 00:27:38 - s_cbr.backend.main - INFO -    âœ… S-CBR èºæ—‹æ¨ç†å¼•æ“
2025-12-09 00:27:38 - s_cbr.backend.main - INFO -    âœ… ANC ç—…ä¾‹ç®¡ç†ç³»çµ±
2025-12-09 00:27:38 - s_cbr.backend.main - INFO - 
2025-12-09 00:27:38 - s_cbr.backend.main - INFO - ğŸ”— å¯ç”¨ç«¯é»:
2025-12-09 00:27:38 - s_cbr.backend.main - INFO -    - èºæ—‹æ¨ç†: /api/scbr/v2/*
2025-12-09 00:27:38 - s_cbr.backend.main - INFO -    - ç—…ä¾‹ä¿å­˜: POST /api/case/save
2025-12-09 00:27:38 - s_cbr.backend.main - INFO -    - ç—…ä¾‹æŸ¥è©¢: GET /api/case/get/{case_id}
2025-12-09 00:27:38 - s_cbr.backend.main - INFO -    - ç—…ä¾‹æœç´¢: POST /api/case/search
2025-12-09 00:27:38 - s_cbr.backend.main - INFO -    - ç—…ä¾‹çµ±è¨ˆ: GET /api/case/stats
2025-12-09 00:27:38 - s_cbr.backend.main - INFO -    - å¥åº·æª¢æŸ¥: GET /healthz
2025-12-09 00:27:38 - s_cbr.backend.main - INFO - ============================================================
2025-12-09 00:27:40 - httpx - INFO - HTTP Request: GET http://localhost:8080/v1/meta "HTTP/1.1 200 OK"
2025-12-09 00:27:40 - httpx - INFO - HTTP Request: GET https://pypi.org/pypi/weaviate-client/json "HTTP/1.1 200 OK"
2025-12-09 00:27:40 - httpx - INFO - HTTP Request: GET http://localhost:8080/v1/schema/TCMCase "HTTP/1.1 200 OK"
2025-12-09 00:27:40 - s_cbr.backend.main - INFO - âœ… ANC ç—…ä¾‹è™•ç†å™¨åˆå§‹åŒ–æˆåŠŸ
2025-12-09 00:28:15 - s_cbr.SCBR-API - INFO - ğŸ“¥ æ”¶åˆ°è¨ºæ–·è«‹æ±‚ [IP: 127.0.0.1]
2025-12-09 00:28:15 - s_cbr.SCBR-API - INFO -    å•é¡Œ: é€™å¹¾å¤©èƒƒå¾ˆä¸èˆ’æœï¼Œæ„Ÿè¦ºè„¹è„¹çš„ï¼ŒæŒ‰ä¸‹å»æ›´ç—›ï¼Œæœ‰é»å™å¿ƒæƒ³åï¼Œå¤§ä¾¿æ¯”è¼ƒç¨€ã€‚...
2025-12-09 00:28:15 - s_cbr.SCBR-API - INFO -    Session ID: None
2025-12-09 00:28:15 - s_cbr.SCBREngine - INFO - ğŸŒ€ å•Ÿå‹•è¨ºæ–· [SCBR-20251209-002815-75b617d7]
2025-12-09 00:28:15 - s_cbr.SCBREngine - INFO -    å•é¡Œ: é€™å¹¾å¤©èƒƒå¾ˆä¸èˆ’æœï¼Œæ„Ÿè¦ºè„¹è„¹çš„ï¼ŒæŒ‰ä¸‹å»æ›´ç—›ï¼Œæœ‰é»å™å¿ƒæƒ³åï¼Œå¤§ä¾¿æ¯”è¼ƒç¨€ã€‚...
2025-12-09 00:28:15 - s_cbr.SCBREngine - INFO -    session_id: None
2025-12-09 00:28:15 - s_cbr.SCBREngine - INFO -    continue_spiral: False
2025-12-09 00:28:15 - s_cbr.DialogManager - INFO - ğŸ†• å‰µå»ºæœƒè©±: daeb124f***
2025-12-09 00:28:15 - s_cbr.DialogManager - INFO -    åˆå§‹å•é¡Œ: é€™å¹¾å¤©èƒƒå¾ˆä¸èˆ’æœï¼Œæ„Ÿè¦ºè„¹è„¹çš„ï¼ŒæŒ‰ä¸‹å»æ›´ç—›ï¼Œæœ‰é»å™å¿ƒæƒ³åï¼Œå¤§ä¾¿æ¯”è¼ƒç¨€ã€‚...
2025-12-09 00:28:15 - s_cbr.DialogManager - INFO -    ç•¶å‰æœƒè©±ç¸½æ•¸: 1
2025-12-09 00:28:15 - s_cbr.SCBREngine - INFO -    æœƒè©±ID: daeb124f-b829-40a2-b1db-b50872e3b23a
2025-12-09 00:28:15 - s_cbr.SCBREngine - INFO -    ç•¶å‰è¼ªæ¬¡: 1
2025-12-09 00:28:15 - s_cbr.SCBREngine - INFO -    ç´¯ç©å•é¡Œ: é€™å¹¾å¤©èƒƒå¾ˆä¸èˆ’æœï¼Œæ„Ÿè¦ºè„¹è„¹çš„ï¼ŒæŒ‰ä¸‹å»æ›´ç—›ï¼Œæœ‰é»å™å¿ƒæƒ³åï¼Œå¤§ä¾¿æ¯”è¼ƒç¨€ã€‚...
2025-12-09 00:28:15 - s_cbr.FourLayerPipeline - INFO - [L1] ä½¿ç”¨å‚³çµ±æ¨¡å¼
2025-12-09 00:28:19 - s_cbr.LLMClient - WARNING - âš ï¸ è¼¸å‡ºéæ¿¾ï¼šæª¢æ¸¬åˆ° 1 è™•æ•æ„Ÿè³‡è¨Š
2025-12-09 00:28:19 - s_cbr.FourLayerPipeline - INFO - [L1 FINAL RESULT] L1 ç‹€æ…‹: ok
2025-12-09 00:28:19 - s_cbr.FourLayerPipeline - INFO - [L1 KEYWORD PLAN]
{
  "symptom_terms": [
    "èƒƒä¸èˆ’æœ",
    "è„¹è„¹çš„",
    "æŒ‰ä¸‹å»æ›´ç—›",
    "å™å¿ƒæƒ³å",
    "å¤§ä¾¿æ¯”è¼ƒç¨€"
  ],
  "tongue_pulse_terms": [],
  "zangfu_terms": [
    "èƒƒ"
  ],
  "other_terms": [
    "è„¹ç—›",
    "å™å¿ƒ"
  ],
  "search_strategy": "exact"
}
2025-12-09 00:28:19 - s_cbr.FourLayerPipeline - INFO - [L1 BEFORE FILTER]
{
  "layer": "L1_GATE",
  "status": "ok",
  "input": {
    "user_query": "é€™å¹¾å¤©èƒƒå¾ˆä¸èˆ’æœï¼Œæ„Ÿè¦ºè„¹è„¹çš„ï¼ŒæŒ‰ä¸‹å»æ›´ç—›ï¼Œæœ‰é»å™å¿ƒæƒ³åï¼Œå¤§ä¾¿æ¯”è¼ƒç¨€ã€‚",
    "history_summary": ""
  },
  "task_recognition": {
    "is_tcm_task": true,
    "tcm_task_type": "diagnosis",
    "reason": "ç”¨æˆ¶æè¿°äº†æ˜é¡¯çš„èƒƒéƒ¨ä¸é©ç—‡ç‹€ï¼ŒåŒ…æ‹¬è„¹ç—›ã€å™å¿ƒå’Œå¤§ä¾¿ç•°å¸¸ï¼Œèˆ‡ä¸­é†«è¨ºæ–·ç›¸é—œã€‚"
  },
  "owasp_screening": {
    "prompt_injection_detected": false,
    "sensitive_info_request": false,
    "system_prompt_leak_attempt": false,
    "excessive_agency_attempt": false,
    "unbounded_consumption_risk": "low",
    "flags": []
  },
  "keyword_plan": {
    "symptom_terms": [
      "èƒƒä¸èˆ’æœ",
      "è„¹è„¹çš„",
      "æŒ‰ä¸‹å»æ›´ç—›",
      "å™å¿ƒæƒ³å",
      "å¤§ä¾¿æ¯”è¼ƒç¨€"
    ],
    "tongue_pulse_terms": [],
    "zangfu_terms": [
      "èƒƒ"
    ],
    "other_terms": [
      "è„¹ç—›",
      "å™å¿ƒ"
    ],
    "search_strategy": "exact"
  },
  "next_action": "vector_search",
  "message_to_user": "å·²æ”¶åˆ°æ‚¨çš„ç—‡ç‹€æè¿°ï¼Œç³»çµ±å°‡é€²è¡Œä¸­é†«è­‰å‹åˆ†æã€‚"
}
2025-12-09 00:28:19 - s_cbr.FourLayerPipeline - INFO - [L1 AFTER  FILTER]
{
  "layer": "L1_GATE",
  "status": "ok",
  "input": {
    "user_query": "é€™å¹¾å¤©èƒƒå¾ˆä¸èˆ’æœï¼Œæ„Ÿè¦ºè„¹è„¹çš„ï¼ŒæŒ‰ä¸‹å»æ›´ç—›ï¼Œæœ‰é»å™å¿ƒæƒ³åï¼Œå¤§ä¾¿æ¯”è¼ƒç¨€ã€‚",
    "history_summary": ""
  },
  "task_recognition": {
    "is_tcm_task": true,
    "tcm_task_type": "diagnosis",
    "reason": "ç”¨æˆ¶æè¿°äº†æ˜é¡¯çš„èƒƒéƒ¨ä¸é©ç—‡ç‹€ï¼ŒåŒ…æ‹¬è„¹ç—›ã€å™å¿ƒå’Œå¤§ä¾¿ç•°å¸¸ï¼Œèˆ‡ä¸­é†«è¨ºæ–·ç›¸é—œã€‚"
  },
  "owasp_screening": {
    "prompt_injection_detected": false,
    "sensitive_info_request": false,
    "[ç³»çµ±è³‡è¨Šå·²éš±è—]_leak_attempt": false,
    "excessive_agency_attempt": false,
    "unbounded_consumption_risk": "low",
    "flags": []
  },
  "keyword_plan": {
    "symptom_terms": [
      "èƒƒä¸èˆ’æœ",
      "è„¹è„¹çš„",
      "æŒ‰ä¸‹å»æ›´ç—›",
      "å™å¿ƒæƒ³å",
      "å¤§ä¾¿æ¯”è¼ƒç¨€"
    ],
    "tongue_pulse_terms": [],
    "zangfu_terms": [
      "èƒƒ"
    ],
    "other_terms": [
      "è„¹ç—›",
      "å™å¿ƒ"
    ],
    "search_strategy": "exact"
  },
  "next_action": "vector_search",
  "message_to_user": "å·²æ”¶åˆ°æ‚¨çš„ç—‡ç‹€æè¿°ï¼Œç³»çµ±å°‡é€²è¡Œä¸­é†«è­‰å‹åˆ†æã€‚"
}
2025-12-09 00:28:19 - s_cbr.FourLayerPipeline - INFO - [RETRIEVAL] ä½¿ç”¨å‚³çµ±æª¢ç´¢æ¨¡å¼
2025-12-09 00:28:21 - s_cbr.SearchEngine - INFO - ğŸ” TCMCase å•Ÿå‹•æª¢ç´¢: Mode=HYBRID, Î±=0.55, æŸ¥è©¢å­—ä¸²é•·åº¦=34 (é€™å¹¾å¤©èƒƒå¾ˆä¸èˆ’æœï¼Œæ„Ÿè¦ºè„¹è„¹çš„ï¼ŒæŒ‰ä¸‹å»æ›´ç—›...)
2025-12-09 00:28:21 - s_cbr.SearchEngine - INFO - ğŸ” TCMCase HYBRID Î±=0.55, qdim=1024, fields=['full_text'], props=['tongue_terms', 'syndrome_terms', 'zangfu_terms', 'updated_at', 'patient_id', 'diagnosis', 'jieba_tokens', 'gender', 'full_text', 'case_id', 'visit_date', 'treatment_terms', 'suggestion', 'pulse_terms', 'age', 'treatment_principle', 'symptom_terms', 'chief_complaint', 'created_at', 'raw_data']
2025-12-09 00:28:21 - s_cbr.SearchEngine - INFO - ğŸ“Š TCMCase æœç´¢: 3 å€‹çµæœ
2025-12-09 00:28:21 - s_cbr.FourLayerPipeline - INFO - [RETRIEVAL RESULT] æˆåŠŸæ‰¾åˆ° 3 å€‹æ¡ˆä¾‹. Top 3 ç¯„ä¾‹: [{'case_id': 'CASE_20251005211408_M508_dfea1255', 'score': '0.5500'}, {'case_id': 'CASE_20251005212325_M456_ea0fddb3', 'score': '0.5412'}, {'case_id': 'CASE_20251005211456_V993_ae529307', 'score': '0.5301'}]
2025-12-09 00:28:30 - s_cbr.FourLayerPipeline - INFO - [L2] ä½¿ç”¨å‚³çµ±æ¨¡å¼ï¼ˆç„¡å·¥å…·å¢å¼·ï¼‰
2025-12-09 00:28:30 - s_cbr.FourLayerPipeline - INFO - [L2 DIAGNOSIS SUMMARY] éŒ¨å®š ID: CASE_20251005212325_M456_ea0fddb3, è­‰å‹: è„¾è™›è­‰ï¼ˆåˆæ­¥å‚¾å‘ï¼‰, è¦†è“‹åº¦: 0.60
2025-12-09 00:28:46 - s_cbr.FourLayerPipeline - INFO - [L3 REVIEW STATUS] å¯©æ ¸çµæœ: rewritten
2025-12-09 00:28:54 - s_cbr.DialogManager - INFO - ğŸ“Š è¨˜éŒ„ç¬¬ 1 è¼ªçµæœåˆ°æœƒè©± daeb124f***
2025-12-09 00:28:54 - s_cbr.SCBREngine - INFO - âœ… è¨ºæ–·å®Œæˆ [SCBR-20251209-002815-75b617d7] è€—æ™‚: 39.14s
2025-12-09 00:28:54 - s_cbr.SCBREngine - INFO -    è¼ªæ¬¡: 1, å¯ç¹¼çºŒ: True
2025-12-09 00:28:54 - s_cbr.SCBR-API - INFO - âœ… è¨ºæ–·å®Œæˆ [IP: 127.0.0.1] è€—æ™‚: 39.14s
