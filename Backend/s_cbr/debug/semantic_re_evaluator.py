
import pandas as pd
import re
import os

# ================= é…ç½®å€åŸŸ =================
# è¼¸å…¥æª”æ¡ˆè·¯å¾‘ (è«‹ç¢ºèªæ‚¨çš„æª”æ¡ˆåç¨±)
AGENTIC_CSV = "test_results/thesis_experiment_data-Agentic.csv"
BASELINE_CSV = "test_results/thesis_experiment_data-Baseline.csv"
# è¼¸å‡ºæª”æ¡ˆè·¯å¾‘ (æ¸…æ´—å¾Œçš„åˆä½µæª”)
OUTPUT_CSV = "test_results/thesis_final_combined_data.csv"

# ğŸ§  [æ ¸å¿ƒçŸ¥è­˜åº«] ä¸­é†«åŒç¾©è©åº« (å¤§å¹…æ“´å……ç‰ˆ)
# æ¶µè“‹ ICD-11ã€å¸¸è¦‹è‡¨åºŠç”¨èªã€è­‰å‹ç°¡ç¨±
SYNONYMS = {
    # --- ç¡çœ èˆ‡ç²¾ç¥é¡ ---
    "ä¸å¯": "å¤±çœ ",
    "ä¸å¾—çœ ": "å¤±çœ ",
    "ç›®ä¸ç‘": "å¤±çœ ",
    "å¤šå¤¢": "å¤±çœ ",  # å»£ç¾©ä¸Šå¸¸åˆä½µè¨è«–
    "å¥å¿˜": "è¨˜æ†¶åŠ›æ¸›é€€",
    "é¬±è­‰": "æ†‚é¬±",
    "è‡Ÿèº": "ç„¦æ…®",
    "ç…©èº": "å¿ƒç…©",

    # --- ç–¼ç—›é¡ ---
    "è…°ç— ": "è…°ç—›",
    "è…°è†ç— è»Ÿ": "è…°ç—›",
    "è…°è„Šç—›": "è…°ç—›",
    "èƒƒè„˜ç—›": "èƒƒç—›",
    "å¿ƒä¸‹ç—›": "èƒƒç—›",
    "èƒƒè„˜ç¼ç—›": "èƒƒç¼ç†±",
    "å˜ˆé›œ": "èƒƒä¸é©",
    "èƒ¸ç—º": "èƒ¸æ‚¶",
    "èƒ¸ç—ºå¿ƒç—›": "èƒ¸æ‚¶",
    "çœŸå¿ƒç—›": "å¿ƒçµç—›",
    "é ­é¢¨": "é ­ç—›",
    "è…¦é¢¨": "é ­ç—›",
    "é¦–é¢¨": "é ­ç—›",
    "åé ­é¢¨": "åé ­ç—›",
    "è„…ç—›": "è„…è‚‹ç—›",
    "ç¶“è¡Œè…¹ç—›": "ç—›ç¶“",
    "ç¶“è¡Œè…¹ç—›": "ç—›ç¶“",
    "å–‰ç—º": "å’½ç—›",
    "å’½å–‰è…«ç—›": "å’½ç—›",
    "ä¹³ç™–": "ä¹³æˆ¿è„¹ç—›",
    "ä¹³æˆ¿è„¹ç—›": "ä¹³ç—›",
    "ç—ºè­‰": "ç—¹è­‰",
    "è‚¢ç¯€ç—›": "é—œç¯€ç—›",
    "æ­·ç¯€": "é—œç¯€ç—›",
    "é¶´è†é¢¨": "è†ç—›",
    "è‚©å‡ç—‡": "è‚©ç—›",
    "æ¼è‚©é¢¨": "è‚©ç—›",
    "è‚©ç—¹": "è‚©ç—›", 
    "è†ç—¹": "è†ç—›",

    # --- äº”å®˜èˆ‡å‘¼å¸é¡ ---
    "é¼»æ·µ": "é¼»ç«‡ç‚",
    "è…¦æ¼": "é¼»ç«‡ç‚",
    "é¼»é¼½": "éæ•æ€§é¼»ç‚",
    "é¼½åš": "éæ•æ€§é¼»ç‚",
    "é¼»å¡": "é¼»é¼½", # ç—‡ç‹€å°æ‡‰ç—…å
    "å’³å—½": "ä¹…å’³", # æœ‰æ™‚æ··ç”¨
    "å“®ç—…": "å“®å–˜",
    "å–˜è­‰": "æ°£å–˜",
    "è‚ºè„¹": "COPD", # æ…¢æ€§é˜»å¡æ€§è‚ºç—…
    "å£ç˜¡": "å£è…”æ½°ç˜",
    "å£ç³œ": "å£è…”æ½°ç˜",
    "ç›®ä¹¾": "ä¹¾çœ¼",
    "ç¥æ°´å°‡æ¯": "ä¹¾çœ¼",
    "è€³é³´": "è€³è¾", # å¸¸ä½µç¨±

    # --- æ¶ˆåŒ–èˆ‡æ’æ³„é¡ ---
    "æ³„ç€‰": "è…¹ç€‰",
    "æ¿¡æ³„": "è…¹ç€‰",
    "é¶©æº": "è…¹ç€‰",
    "ä¾¿ç§˜": "å¤§ä¾¿ä¹¾çµ",
    "å¤§ä¾¿é›£": "ä¾¿ç§˜",
    "è„¾ç´„": "ä¾¿ç§˜",
    "æ¶ˆæ¸´": "ç³–å°¿ç—…",
    "è†ˆæ¶ˆ": "ç³–å°¿ç—…",
    "è‚ºæ¶ˆ": "ç³–å°¿ç—…",
    "ç´å·®": "é£Ÿæ…¾ä¸æŒ¯",
    "ä¸æ€é£²é£Ÿ": "é£Ÿæ…¾ä¸æŒ¯",
    "ç´å‘†": "é£Ÿæ…¾ä¸æŒ¯",
    "é£Ÿå°‘": "é£Ÿæ…¾ä¸æŒ¯",
    "å‘ƒé€†": "æ‰“å—",
    "å™¯æ°£": "æ‰“å—",

    # --- å©¦ç§‘èˆ‡å…¶ä»– ---
    "ç™­ç—…": "ç”²ç‹€è…º",
    "ç™­æ°£": "ç”²ç‹€è…ºåŠŸèƒ½äº¢é€²",
    "ç”²äº¢": "ç”²ç‹€è…ºåŠŸèƒ½äº¢é€²",
    "æœˆç¶“å¾ŒæœŸ": "æœˆç¶“å»¶å¾Œ",
    "ç¶“è¡Œå¾ŒæœŸ": "æœˆç¶“å»¶å¾Œ",
    "æœˆç¶“å…ˆæœŸ": "æœˆç¶“æå‰",
    "æœˆç¶“é‡å¤š": "å´©æ¼", # å»£ç¾©
    "å´©ä¸­": "å´©æ¼",
    "æ¼ä¸‹": "å´©æ¼",
    "å¸¶ä¸‹ç—…": "é™°é“ç‚", # ç¾ä»£å°æ‡‰
    "ç™®ç–¹": "æ¿•ç–¹",
    "é¢¨ç–¹": "æ¿•ç–¹", # ä¸­é†«å¤ç¨±é¢¨ç–¹å¡Šå¸¸æŒ‡è•éº»ç–¹/æ¿•ç–¹
    "æ¿•ç˜¡": "æ¿•ç–¹",
    "ç²‰åˆº": "ç—¤ç˜¡",
    "è‚ºé¢¨ç²‰åˆº": "ç—¤ç˜¡",

    # --- è­‰å‹ç”¨èªæ¨™æº–åŒ– (å°‡ä¸åŒèªªæ³•çµ±ä¸€) ---
    "è„¾èƒƒæ°£æ»¯": "èƒƒè„¹", # ç—‡ç‹€åç•¶è­‰å‹ç”¨æ™‚
    "è‚é¬±æ°£æ»¯": "è‚æ°£é¬±çµ",
    "è‚æ°£é¬±": "è‚æ°£é¬±çµ",
    "æ°£æ»¯è¡€ç˜€": "æ°£æ»¯è¡€ç˜€", # çµ±ä¸€
    "æ°£è™›è¡€ç˜€": "æ°£è™›è¡€ç˜€",
    "å¿ƒè„¾å…©è™›": "å¿ƒè„¾æ°£è¡€å…©è™›", # çµ±ä¸€é•·å
    "æ°£è¡€å…©è™›": "å¿ƒè„¾å…©è™›",     # å¸¸è¦‹äº’é€š
    "æ°£è¡€ä¸è¶³": "æ°£è¡€å…©è™›",
    "è…é™½è™›": "è…è™›", # å¯¬é¬†æ¯”å°ç”¨
    "è…é™°è™›": "è…è™›",
    "è…æ°£è™›": "è…è™›",
    "è…ç²¾ä¸è¶³": "è…è™›",
    "è‚ç«ä¸Šç‚": "è‚ç«æ—º",
    "è‚é¬±åŒ–ç«": "è‚ç«æ—º",
    "æ¿•ç†±ä¸‹æ³¨": "æ¿•ç†±",
    "æ¿•ç†±å…§è˜Š": "æ¿•ç†±",
    "å¯’æ¿•å›°è„¾": "å¯’æ¿•",
    "è„¾è™›æ¿•å›°": "è„¾è™›æ¿•ç››",
    "è‚ºæ°£è™›å¯’": "è‚ºæ°£è™›",
    "çƒ˜ç†±": "æ½®ç†±",
    "æ½®ç†±ç›œæ±—": "é™°è™›",
}

def normalize_term(text):
    """æ¨™æº–åŒ–è¡“èªï¼šå»æ‹¬è™Ÿã€å»æ¨™é»ã€è½‰åŒç¾©è©"""
    if not isinstance(text, str): return ""
    # 1. çµ±ä¸€å…¨å½¢æ‹¬è™Ÿèˆ‡ç§»é™¤å…§å®¹ (é€šå¸¸æ‹¬è™Ÿå…§æ˜¯è­‰å‹ï¼Œæ‹¬è™Ÿå¤–æ˜¯ç—…åï¼Œæˆ‘å€‘ä¸»è¦æ¯”å°æ ¸å¿ƒæ¦‚å¿µ)
    # ç­–ç•¥ï¼šä¿ç•™æ ¸å¿ƒç—…åå’Œæ ¸å¿ƒè­‰å‹ï¼Œç§»é™¤æ¨™é»
    text = text.replace("ï¼ˆ", "(").replace("ï¼‰", ")")
    
    # 2. ç§»é™¤æ¨™é»ç¬¦è™Ÿ (åªç•™æ–‡å­—)
    text = re.sub(r'[^\w\s]', '', text) 
    
    # 3. æ‡‰ç”¨åŒç¾©è©åº« (å°‡å¤æ–‡è½‰ç‚ºç¾ä»£é€šç”¨è©ï¼Œæˆ–çµ±ä¸€æ¨™æº–)
    # é€²è¡Œå¤šæ¬¡æ›¿æ›ä»¥ç¢ºä¿è¦†è“‹ï¼ˆä¾‹å¦‚ A->B, B->Cï¼Œå‰‡ A->Cï¼‰
    for _ in range(2): 
        for key, val in SYNONYMS.items():
            text = text.replace(key, val)
    
    return text

def semantic_judge(row):
    """
    é€²éšèªæ„è£åˆ¤é‚è¼¯ (Semantic Scoring)
    """
    truth_raw = str(row['Ground_Truth'])
    pred_raw = str(row['Predicted_Pattern'])
    
    # 1. é è™•ç†
    truth = normalize_term(truth_raw)
    pred = normalize_term(pred_raw)
    
    # 2. åŸºç¤æ¸…æ´—å¾Œç›¸ç­‰ (Exact Match after normalization)
    if truth == pred: return 1
    
    # 3. äº’ç›¸åŒ…å« (Inclusion Match)
    # ä¾‹å¦‚ Truth="å¤±çœ ", Pred="å¤±çœ (å¿ƒè„¾å…©è™›)" -> åŒ…å«"å¤±çœ "ï¼Œç®—å°
    if truth in pred or pred in truth: return 1
    
    # 4. æ ¸å¿ƒé—œéµå­—é‡ç–Šç‡ (Jaccard Similarity)
    # å°‡å­—ä¸²æ‹†æˆå­—å…ƒé›†åˆ
    set_t = set(truth)
    set_p = set(pred)
    
    # æ’é™¤ç„¡æ„ç¾©çš„ä¸­æ–‡å­— (Stopwords)
    stopwords = {'è­‰', 'å‹', 'ç—…', 'ç—›', ' ', '(', ')', 'ä¹‹', 'ç—‡', 'å€™', 'å‚¾', 'å‘', 'åˆ', 'æ­¥', 'é¡', 'ä¼¼'}
    set_t = set_t - stopwords
    set_p = set_p - stopwords
    
    if not set_t: return 0
    
    intersection = len(set_t.intersection(set_p))
    union = len(set_t.union(set_p))
    
    # Jaccard åˆ†æ•¸ (0.0 - 1.0)
    score = intersection / union if union > 0 else 0
    
    # åˆ¤å®šé–€æª»ï¼šè‹¥é—œéµå­—é‡ç–Šè¶…é 40% (å°æ–¼çŸ­è©é€™å¾ˆé«˜)ï¼Œè¦–ç‚ºèªæ„æ­£ç¢º
    # ä¾‹å¦‚ "æ°£è¡€å…©è™›" (4å­—) vs "æ°£è¡€ä¸è¶³" (4å­—) -> é‡ç–Š "æ°£è¡€" (2å­—) -> Jaccard ç´„ 0.33~0.5
    if score >= 0.4: return 1
    
    # 5. (æ–°å¢) è‡Ÿè…‘ç—…æ©Ÿå¯¬é¬†å‘½ä¸­ (Loose Organ-Pathology Match)
    # å¦‚æœ Truth è£¡é¢çš„æ ¸å¿ƒè‡Ÿè…‘ (å¿ƒ/è‚/è„¾/è‚º/è…) åœ¨ Pred è£¡ä¹Ÿæœ‰ï¼Œä¸”ç—…æ©Ÿ (è™›/å¯¦/å¯’/ç†±) ä¹Ÿä¸€è‡´
    # é€™èƒ½è§£æ±º "è„¾èƒƒè™›å¼±" vs "è„¾æ°£è™›" é€™ç¨®å­—é¢ä¸Š Jaccard å¾ˆä½ä½†èªæ„æ¥è¿‘çš„æƒ…æ³
    
    core_organs = ['å¿ƒ', 'è‚', 'è„¾', 'è‚º', 'è…', 'èƒƒ', 'è†½']
    core_patho = ['è™›', 'å¯¦', 'å¯’', 'ç†±', 'ç˜€', 'æ»¯', 'ç—°', 'æ¿•', 'ç«']
    
    # æª¢æŸ¥æ˜¯å¦å‘½ä¸­ç›¸åŒçš„è‡Ÿè…‘
    match_organ = any(o in truth and o in pred for o in core_organs)
    # æª¢æŸ¥æ˜¯å¦å‘½ä¸­ç›¸åŒçš„ç—…æ©Ÿæ€§è³ª
    match_patho = any(p in truth and p in pred for p in core_patho)
    
    # å¦‚æœè‡Ÿè…‘å’Œç—…æ©Ÿéƒ½å°ä¸Šäº†ï¼Œå³ä½¿å…¶ä»–å­—ä¸åŒï¼Œä¹Ÿç®—å»£ç¾©æ­£ç¢º
    # ä¾‹å¦‚ "è„¾æ°£è™›" vs "è„¾èƒƒè™›å¼±" -> éƒ½æœ‰"è„¾" + éƒ½æœ‰"è™›" -> æ­£ç¢º
    if match_organ and match_patho:
        return 1
    
    return 0

def process_file(filepath, group_name):
    if not os.path.exists(filepath):
        print(f"âŒ æ‰¾ä¸åˆ°æª”æ¡ˆ: {filepath}")
        return None

    print(f"ğŸ“– æ­£åœ¨è™•ç†: {group_name} ({filepath})...")
    df = pd.read_csv(filepath)
    
    # ç¢ºä¿ Is_Correct ç‚ºæ•¸å€¼
    df['Is_Correct'] = pd.to_numeric(df['Is_Correct'], errors='coerce').fillna(0)

    # è¨ˆç®—åŸå§‹æº–ç¢ºç‡
    original_acc = df['Is_Correct'].mean()
    
    # æ‡‰ç”¨æ–°çš„è£åˆ¤é‚è¼¯
    df['Is_Correct_Semantic'] = df.apply(semantic_judge, axis=1)
    new_acc = df['Is_Correct_Semantic'].mean()
    
    print(f"   - åŸå§‹æº–ç¢ºç‡ (String Match): {original_acc:.2%}")
    print(f"   - èªæ„æº–ç¢ºç‡ (Semantic):     {new_acc:.2%}")
    print(f"   - æ ¡æ­£æå‡å¹…åº¦: +{(new_acc - original_acc):.2%}")
    
    # æ¨™è¨˜çµ„åˆ¥
    df['Group'] = group_name
    return df

def main():
    # 1. è™•ç†å…©çµ„æ•¸æ“š
    df_agentic = process_file(AGENTIC_CSV, "Agentic (Experiment)")
    df_baseline = process_file(BASELINE_CSV, "Baseline (Control)")
    
    if df_agentic is not None and df_baseline is not None:
        # 2. åˆä½µæ•¸æ“š
        combined_df = pd.concat([df_agentic, df_baseline])
        
        # 3. å„²å­˜æœ€çµ‚æ•¸æ“šé›†
        # ä½¿ç”¨ os.getcwd() ç¢ºä¿è·¯å¾‘æ­£ç¢º
        output_path = os.path.join(os.getcwd(), OUTPUT_CSV)
        combined_df.to_csv(output_path, index=False, encoding='utf-8-sig')
        print(f"\nâœ… æ•¸æ“šæ¸…æ´—å®Œæˆï¼æœ€çµ‚æª”æ¡ˆå·²ç”Ÿæˆ: {output_path}")
        print("ğŸ‘‰ è«‹æ¥è‘—åŸ·è¡Œç¹ªåœ–è…³æœ¬ (plot_thesis_charts.py) ä¾†ç”Ÿæˆè«–æ–‡åœ–è¡¨ã€‚")
    else:
        print("\nâŒ ç¼ºå°‘å¿…è¦çš„ CSV æª”æ¡ˆï¼Œç„¡æ³•åˆä½µã€‚")

if __name__ == "__main__":
    main()